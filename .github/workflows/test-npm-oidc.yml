name: Test npm OIDC Authentication

on:
  workflow_dispatch:
    inputs:
      test_version:
        description: 'Test version (e.g., 0.0.0-test)'
        required: true
        default: '0.0.0-test'

jobs:
  test-oidc-auth:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.x'
          registry-url: 'https://registry.npmjs.org'
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Verify OIDC authentication
        run: |
          echo "Testing OIDC authentication with npm..."
          # This will verify that OIDC authentication is working
          # If it fails, it means the trusted publisher is not configured correctly
          npm whoami --registry=https://registry.npmjs.org
          echo "✅ Successfully authenticated with npm using OIDC!"
      - name: Test publish (dry-run)
        run: |
          echo "Running dry-run publish test..."
          # This will test the full publish flow without actually publishing
          npm publish --dry-run --access public
          echo "✅ OIDC authentication test passed! The workflow can authenticate with npm."

