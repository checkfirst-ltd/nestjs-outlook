name: Test npm OIDC Authentication

on:
  push:
    branches:
      - '41-migrate-npm-publish-workflow-to-oidc-authentication'
  pull_request:
    branches:
      - '41-migrate-npm-publish-workflow-to-oidc-authentication'
  workflow_dispatch:
    inputs:
      test_version:
        description: 'Test version (e.g., 0.0.0-test)'
        required: true
        default: '0.0.0-test'
permissions:
  id-token: write
  contents: read
    
jobs:
  test-oidc-auth:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
          # OIDC will be used automatically if no NODE_AUTH_TOKEN is set
      - name: Verify Node.js and npm versions
        run: |
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          # Verify npm version supports OIDC (11.5.1+)
          NPM_VERSION=$(npm --version | cut -d. -f1,2)
          REQUIRED_VERSION="11.5"
          if [ "$(printf '%s\n' "$REQUIRED_VERSION" "$NPM_VERSION" | sort -V | head -n1)" != "$REQUIRED_VERSION" ]; then
            echo "‚ö†Ô∏è  npm version $NPM_VERSION is below required $REQUIRED_VERSION for OIDC"
            echo "Installing latest npm..."
            npm install -g npm@latest
            echo "New npm version: $(npm --version)"
          else
            echo "‚úÖ npm version $NPM_VERSION supports OIDC"
          fi
      - name: Install dependencies
        env:
          NODE_AUTH_TOKEN: ""
        run: npm ci
      - name: Build
        env:
          NODE_AUTH_TOKEN: ""
        run: npm run build
      - name: Verify OIDC prerequisites
        run: |
          echo "Verifying OIDC prerequisites..."
          echo ""
          echo "Checking environment variables:"
          if [ -n "$NODE_AUTH_TOKEN" ]; then
            echo "‚ö†Ô∏è  WARNING: NODE_AUTH_TOKEN is set. This might interfere with OIDC."
            echo "   If you have NPM_TOKEN secret, remove it from repository secrets for OIDC to work."
          else
            echo "‚úÖ NODE_AUTH_TOKEN is not set (correct for OIDC)"
          fi
          echo ""
          echo "Checking GitHub Actions OIDC environment variables:"
          if [ -n "$ACTIONS_ID_TOKEN_REQUEST_URL" ]; then
            echo "‚úÖ ACTIONS_ID_TOKEN_REQUEST_URL is set"
          else
            echo "‚ùå ACTIONS_ID_TOKEN_REQUEST_URL is not set (required for OIDC)"
          fi
          if [ -n "$ACTIONS_ID_TOKEN_REQUEST_TOKEN" ]; then
            echo "‚úÖ ACTIONS_ID_TOKEN_REQUEST_TOKEN is set"
          else
            echo "‚ùå ACTIONS_ID_TOKEN_REQUEST_TOKEN is not set (required for OIDC)"
          fi
          echo ""
          echo "GitHub Actions context:"
          echo "  Repository: ${{ github.repository }}"
          echo "  Workflow: ${{ github.workflow }}"
          echo "  Workflow file path: .github/workflows/test-npm-oidc.yml"
          echo ""
          echo "‚úÖ All prerequisites for OIDC are met:"
          echo "   - npm version supports OIDC (11.6.2+)"
          echo "   - OIDC environment variables are available"
          echo "   - No token-based authentication is interfering"
          echo "   - Repository: checkfirst-ltd/nestjs-outlook"
          echo "   - Workflow: .github/workflows/test-npm-oidc.yml"
          echo ""
          echo "‚ÑπÔ∏è  Note: According to npm docs, OIDC authentication only works during 'npm publish'"
          echo "   The 'npm whoami' command will NOT work with OIDC."
      - name: Test OIDC authentication with npm token exchange
        env:
          NODE_AUTH_TOKEN: ""
        run: |
          echo "Testing OIDC authentication..."
          echo ""
          echo "According to npm documentation:"
          echo "  - OIDC authentication only occurs during 'npm publish' operations"
          echo "  - 'npm whoami' will NOT reflect OIDC authentication status"
          echo "  - 'npm publish --dry-run' does NOT authenticate with the registry"
          echo ""
          echo "We'll test OIDC by exchanging the GitHub OIDC token for an npm token."
          echo "This verifies the trusted publisher is configured without actually publishing."
          echo ""
          # Get the OIDC token from GitHub Actions
          echo "Requesting OIDC token from GitHub..."
          OIDC_RESPONSE=$(curl -s -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=npm:registry.npmjs.org")
          
          # Extract token from JSON response (works with or without jq)
          if command -v jq >/dev/null 2>&1; then
            OIDC_TOKEN=$(echo "$OIDC_RESPONSE" | jq -r '.value')
          else
            # Fallback: extract token using sed/grep
            OIDC_TOKEN=$(echo "$OIDC_RESPONSE" | grep -o '"value":"[^"]*' | cut -d'"' -f4)
          fi
          
          if [ -z "$OIDC_TOKEN" ] || [ "$OIDC_TOKEN" = "null" ] || [ "$OIDC_TOKEN" = "" ]; then
            echo "‚ùå Failed to obtain OIDC token from GitHub Actions"
            echo "Response: $OIDC_RESPONSE"
            exit 1
          fi
          
          echo "‚úÖ OIDC token obtained from GitHub"
          echo ""
          echo "Exchanging OIDC token for npm registry token..."
          # Exchange OIDC token for npm token using npm's API
          # This endpoint validates the trusted publisher configuration
          NPM_TOKEN_RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H "Content-Type: application/json" \
            -H "Accept: application/json" \
            -d "{\"id_token\":\"$OIDC_TOKEN\"}" \
            "https://registry.npmjs.org/-/npm/v1/oidc/token" 2>/dev/null || echo -e "\n000")
          
          HTTP_CODE=$(echo "$NPM_TOKEN_RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$NPM_TOKEN_RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "‚úÖ OIDC authentication test passed!"
            echo "   Successfully exchanged OIDC token for npm registry token."
            echo "   This confirms the trusted publisher is correctly configured."
          else
            echo ""
            echo "‚ùå Authentication test failed (HTTP $HTTP_CODE)!"
            echo "Response: $RESPONSE_BODY"
            echo ""
            echo "This means the trusted publisher is NOT configured correctly on npmjs.com."
            echo ""
            echo "üìã To fix this, configure the trusted publisher:"
            echo ""
            echo "1. Go to: https://www.npmjs.com/package/@checkfirst/nestjs-outlook/settings"
            echo "2. Click on 'Trusted Publishers' in the left sidebar"
            echo "3. Click 'Add Trusted Publisher'"
            echo "4. Select 'GitHub Actions'"
            echo "5. Enter the following EXACT values (case-sensitive):"
            echo "   - Repository: checkfirst-ltd/nestjs-outlook"
            echo "   - Workflow file: .github/workflows/test-npm-oidc.yml"
            echo "     (must include the .yml extension and match exactly)"
            echo "   - Environment: (leave blank for default)"
            echo "6. Click 'Add Trusted Publisher'"
            echo ""
            echo "‚ö†Ô∏è  Important: npm does NOT verify your configuration when you save it."
            echo "   Double-check that the repository and workflow filename match EXACTLY."
            echo ""
            exit 1
          fi
      - name: Verify dry-run publish (package validation only)
        env:
          NODE_AUTH_TOKEN: ""
        run: |
          echo "Running dry-run publish to validate package (does not test authentication)..."
          npm publish --dry-run --access public
          echo "‚úÖ Package validation passed (this does not verify OIDC authentication)."

