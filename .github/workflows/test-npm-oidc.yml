name: Test npm OIDC Authentication

on:
  push:
    branches:
      - '41-migrate-npm-publish-workflow-to-oidc-authentication'
  pull_request:
    branches:
      - '41-migrate-npm-publish-workflow-to-oidc-authentication'
  workflow_dispatch:
    inputs:
      test_version:
        description: 'Test version (e.g., 0.0.0-test)'
        required: true
        default: '0.0.0-test'

jobs:
  test-oidc-auth:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          # Don't set registry-url here to avoid token-based auth
          # OIDC will be handled directly by npm
      - name: Configure npm registry for OIDC
        run: |
          # Remove any token-based .npmrc that setup-node might have created
          if [ -f "$NPM_CONFIG_USERCONFIG" ]; then
            echo "Removing token-based .npmrc to use OIDC instead..."
            rm -f "$NPM_CONFIG_USERCONFIG"
          fi
          # Unset NODE_AUTH_TOKEN to prevent token-based auth
          unset NODE_AUTH_TOKEN
          # Set registry without auth token (OIDC will handle auth)
          npm config set registry https://registry.npmjs.org/
          npm config delete //registry.npmjs.org/:_authToken || true
          echo "‚úÖ Configured npm to use OIDC authentication"
      - name: Verify Node.js and npm versions
        run: |
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          # Verify npm version supports OIDC (11.5.1+)
          NPM_VERSION=$(npm --version | cut -d. -f1,2)
          REQUIRED_VERSION="11.5"
          if [ "$(printf '%s\n' "$REQUIRED_VERSION" "$NPM_VERSION" | sort -V | head -n1)" != "$REQUIRED_VERSION" ]; then
            echo "‚ö†Ô∏è  npm version $NPM_VERSION is below required $REQUIRED_VERSION for OIDC"
            echo "Installing latest npm..."
            npm install -g npm@latest
            echo "New npm version: $(npm --version)"
          else
            echo "‚úÖ npm version $NPM_VERSION supports OIDC"
          fi
      - name: Install dependencies
        env:
          NODE_AUTH_TOKEN: ""
        run: npm ci
      - name: Build
        env:
          NODE_AUTH_TOKEN: ""
        run: npm run build
      - name: Verify OIDC authentication
        env:
          NODE_AUTH_TOKEN: ""
        run: |
          echo "Testing OIDC authentication with npm..."
          echo ""
          echo "Checking environment variables:"
          if [ -n "$NODE_AUTH_TOKEN" ]; then
            echo "‚ö†Ô∏è  WARNING: NODE_AUTH_TOKEN is set. This might interfere with OIDC."
            echo "   If you have NPM_TOKEN secret, remove it from repository secrets for OIDC to work."
          else
            echo "‚úÖ NODE_AUTH_TOKEN is not set (correct for OIDC)"
          fi
          echo ""
          echo "Checking .npmrc configuration:"
          if [ -f "$HOME/.npmrc" ]; then
            echo "Contents of $HOME/.npmrc:"
            # Mask any tokens in the output
            sed 's/\(//registry.npmjs.org/:_authToken=\).*/\1[REDACTED]/' "$HOME/.npmrc" || cat "$HOME/.npmrc"
          else
            echo "No .npmrc file found in $HOME"
          fi
          if [ -f "$NPM_CONFIG_USERCONFIG" ]; then
            echo "Contents of $NPM_CONFIG_USERCONFIG:"
            sed 's/\(//registry.npmjs.org/:_authToken=\).*/\1[REDACTED]/' "$NPM_CONFIG_USERCONFIG" || cat "$NPM_CONFIG_USERCONFIG"
          fi
          echo ""
          echo "Checking GitHub Actions OIDC environment variables:"
          if [ -n "$ACTIONS_ID_TOKEN_REQUEST_URL" ]; then
            echo "‚úÖ ACTIONS_ID_TOKEN_REQUEST_URL is set"
          else
            echo "‚ùå ACTIONS_ID_TOKEN_REQUEST_URL is not set (required for OIDC)"
          fi
          if [ -n "$ACTIONS_ID_TOKEN_REQUEST_TOKEN" ]; then
            echo "‚úÖ ACTIONS_ID_TOKEN_REQUEST_TOKEN is set"
          else
            echo "‚ùå ACTIONS_ID_TOKEN_REQUEST_TOKEN is not set (required for OIDC)"
          fi
          echo ""
          echo "GitHub Actions context:"
          echo "  Repository: ${{ github.repository }}"
          echo "  Workflow: ${{ github.workflow }}"
          echo "  Workflow file path: .github/workflows/test-npm-oidc.yml"
          echo "  Ref: ${{ github.ref }}"
          echo "  SHA: ${{ github.sha }}"
          echo ""
          echo "‚úÖ All prerequisites for OIDC are met:"
          echo "   - npm version supports OIDC (11.6.2)"
          echo "   - OIDC environment variables are available"
          echo "   - No token-based authentication is interfering"
          echo "   - Repository: checkfirst-ltd/nestjs-outlook"
          echo "   - Workflow: .github/workflows/test-npm-oidc.yml"
          echo ""
          echo "Attempting to authenticate with npm using OIDC..."
          echo ""
          echo "Debugging npm configuration:"
          echo "  npm config get registry: $(npm config get registry)"
          echo "  npm config get //registry.npmjs.org/:_authToken: $(npm config get //registry.npmjs.org/:_authToken || echo 'not set')"
          echo ""
          echo "‚ö†Ô∏è  Important notes about trusted publisher configuration:"
          echo "  1. The workflow file path must be: .github/workflows/test-npm-oidc.yml"
          echo "     (with the leading dot and forward slashes)"
          echo "  2. The repository must be: checkfirst-ltd/nestjs-outlook"
          echo "     (no .git suffix, lowercase)"
          echo "  3. Make sure you clicked 'Save' or 'Add Trusted Publisher' after entering the values"
          echo "  4. There may be a short delay (1-2 minutes) for the configuration to take effect"
          echo ""
          # This will verify that OIDC authentication is working
          # npm will automatically use OIDC when trusted publisher is configured
          # and no token is present
          npm whoami || {
            echo ""
            echo "‚ùå Authentication failed with ENEEDAUTH error"
            echo ""
            echo "This means the trusted publisher is NOT configured on npmjs.com yet."
            echo ""
            echo "üìã To fix this, configure the trusted publisher:"
            echo ""
            echo "1. Go to: https://www.npmjs.com/package/@checkfirst/nestjs-outlook/settings"
            echo "2. Click on 'Trusted Publishers' in the left sidebar"
            echo "3. Click 'Add Trusted Publisher'"
            echo "4. Select 'GitHub Actions'"
            echo "5. Enter the following EXACT values:"
            echo "   - Repository: checkfirst-ltd/nestjs-outlook"
            echo "   - Workflow file: .github/workflows/test-npm-oidc.yml"
            echo "   - Environment: (leave blank for default)"
            echo "6. Click 'Add Trusted Publisher'"
            echo ""
            echo "‚ö†Ô∏è  Important: The repository and workflow path must match EXACTLY (case-sensitive)"
            echo ""
            echo "üí° Troubleshooting tips:"
            echo "   - Double-check the workflow file path includes the leading dot: .github/workflows/..."
            echo "   - Verify the repository name is exactly: checkfirst-ltd/nestjs-outlook (no .git)"
            echo "   - Make sure you saved the trusted publisher configuration"
            echo "   - Wait 1-2 minutes after saving for the configuration to propagate"
            echo "   - Try running the workflow from the main branch if it still doesn't work"
            echo ""
            echo "After configuring, re-run this workflow to test OIDC authentication."
            exit 1
          }
          echo "‚úÖ Successfully authenticated with npm using OIDC!"
      - name: Test publish (dry-run)
        env:
          NODE_AUTH_TOKEN: ""
        run: |
          echo "Running dry-run publish test..."
          # This will test the full publish flow without actually publishing
          npm publish --dry-run --access public
          echo "‚úÖ OIDC authentication test passed! The workflow can authenticate with npm."

