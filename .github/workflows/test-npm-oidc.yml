name: Test npm OIDC Authentication

on:
  push:
    branches:
      - '41-migrate-npm-publish-workflow-to-oidc-authentication'
  pull_request:
    branches:
      - '41-migrate-npm-publish-workflow-to-oidc-authentication'
  workflow_dispatch:
    inputs:
      test_version:
        description: 'Test version (e.g., 0.0.0-test)'
        required: true
        default: '0.0.0-test'

jobs:
  test-oidc-auth:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          # Don't set registry-url here to avoid token-based auth
          # OIDC will be handled directly by npm
      - name: Configure npm registry for OIDC
        run: |
          # Remove any token-based .npmrc that setup-node might have created
          if [ -f "$NPM_CONFIG_USERCONFIG" ]; then
            echo "Removing token-based .npmrc to use OIDC instead..."
            rm -f "$NPM_CONFIG_USERCONFIG"
          fi
          # Unset NODE_AUTH_TOKEN to prevent token-based auth
          unset NODE_AUTH_TOKEN
          # Set registry without auth token (OIDC will handle auth)
          npm config set registry https://registry.npmjs.org/
          npm config delete //registry.npmjs.org/:_authToken || true
          echo "✅ Configured npm to use OIDC authentication"
      - name: Verify Node.js and npm versions
        run: |
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          # Verify npm version supports OIDC (11.5.1+)
          NPM_VERSION=$(npm --version | cut -d. -f1,2)
          REQUIRED_VERSION="11.5"
          if [ "$(printf '%s\n' "$REQUIRED_VERSION" "$NPM_VERSION" | sort -V | head -n1)" != "$REQUIRED_VERSION" ]; then
            echo "⚠️  npm version $NPM_VERSION is below required $REQUIRED_VERSION for OIDC"
            echo "Installing latest npm..."
            npm install -g npm@latest
            echo "New npm version: $(npm --version)"
          else
            echo "✅ npm version $NPM_VERSION supports OIDC"
          fi
      - name: Install dependencies
        env:
          NODE_AUTH_TOKEN: ""
        run: npm ci
      - name: Build
        env:
          NODE_AUTH_TOKEN: ""
        run: npm run build
      - name: Verify OIDC authentication
        env:
          NODE_AUTH_TOKEN: ""
        run: |
          echo "Testing OIDC authentication with npm..."
          echo ""
          echo "Checking environment variables:"
          if [ -n "$NODE_AUTH_TOKEN" ]; then
            echo "⚠️  WARNING: NODE_AUTH_TOKEN is set. This might interfere with OIDC."
            echo "   If you have NPM_TOKEN secret, remove it from repository secrets for OIDC to work."
          else
            echo "✅ NODE_AUTH_TOKEN is not set (correct for OIDC)"
          fi
          echo ""
          echo "Checking .npmrc configuration:"
          if [ -f "$HOME/.npmrc" ]; then
            echo "Contents of $HOME/.npmrc:"
            # Mask any tokens in the output
            sed 's/\(//registry.npmjs.org/:_authToken=\).*/\1[REDACTED]/' "$HOME/.npmrc" || cat "$HOME/.npmrc"
          else
            echo "No .npmrc file found in $HOME"
          fi
          if [ -f "$NPM_CONFIG_USERCONFIG" ]; then
            echo "Contents of $NPM_CONFIG_USERCONFIG:"
            sed 's/\(//registry.npmjs.org/:_authToken=\).*/\1[REDACTED]/' "$NPM_CONFIG_USERCONFIG" || cat "$NPM_CONFIG_USERCONFIG"
          fi
          echo ""
          echo "Attempting to authenticate with npm using OIDC..."
          echo "⚠️  NOTE: If this fails, ensure you've configured the trusted publisher on npmjs.com:"
          echo "   1. Go to https://www.npmjs.com/package/@checkfirst/nestjs-outlook/settings"
          echo "   2. Navigate to 'Trusted Publishers'"
          echo "   3. Add trusted publisher for:"
          echo "      - Repository: checkfirst-ltd/nestjs-outlook"
          echo "      - Workflow: .github/workflows/test-npm-oidc.yml"
          echo ""
          echo "Also ensure NPM_TOKEN secret is removed from repository secrets."
          echo ""
          # This will verify that OIDC authentication is working
          # npm will automatically use OIDC when trusted publisher is configured
          # and no token is present
          npm whoami || {
            echo ""
            echo "❌ Authentication failed!"
            echo "This usually means:"
            echo "  1. Trusted publisher is not configured on npmjs.com (most likely)"
            echo "  2. Repository/workflow path doesn't match the trusted publisher configuration"
            echo "  3. npm version is too old (need 11.5.1+)"
            exit 1
          }
          echo "✅ Successfully authenticated with npm using OIDC!"
      - name: Test publish (dry-run)
        env:
          NODE_AUTH_TOKEN: ""
        run: |
          echo "Running dry-run publish test..."
          # This will test the full publish flow without actually publishing
          npm publish --dry-run --access public
          echo "✅ OIDC authentication test passed! The workflow can authenticate with npm."

